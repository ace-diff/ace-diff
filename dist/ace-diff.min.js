/*!
* ace-diff
* @author Ben Keen
* @version 0.1.0
* @date Mar 21, 2015
* @repo http://github.com/benkeen/ace-diff
*/
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b(require()):a.AceDiff=b(a)}(this,function(){"use strict";function a(a){this.options={},A(!0,this.options,{mode:null,theme:null,diffGranularity:G.DIFF_GRANULARITY_BROAD,lockScrolling:!1,showDiffs:!0,showConnectors:!0,maxDiffs:5e3,left:{id:"acediff-left-editor",content:null,mode:null,theme:null,editable:!0,copyLinkEnabled:!0},right:{id:"acediff-right-editor",content:null,mode:null,theme:null,editable:!0,copyLinkEnabled:!0},merge:{id:"acediff-merge-editor",content:null,mode:null,theme:null,editable:!0,copyLinkEnabled:!0,enabled:!1},classes:{leftGutterID:"acediff-gutter",rightGutterID:"acediff-gutter",gutterID:"acediff-gutter",diff:"acediff-diff",connector:"acediff-connector",newCodeConnectorLink:"acediff-new-code-connector-copy",newCodeConnectorLinkContent:"&#8594;",deletedCodeConnectorLink:"acediff-deleted-code-connector-copy",deletedCodeConnectorLinkContent:"&#8592;",copyRightContainer:"acediff-copy-right",copyLeftContainer:"acediff-copy-left"},connectorYOffset:0},a),this.editors={left:{ace:ace.edit(this.options.left.id),markers:[],lineLengths:[]},right:{ace:ace.edit(this.options.right.id),markers:[],lineLengths:[]},editorHeight:null},this.options.merge.enabled&&(this.editors.merge={ace:this.options.merge.enabled?ace.edit(this.options.merge.id):null,markers:[],lineLengths:[]}),d(this),this.lineHeight=this.editors.left.ace.renderer.lineHeight,this.editors.left.ace.getSession().setMode(b(this,G.EDITOR_LEFT)),this.editors.right.ace.getSession().setMode(b(this,G.EDITOR_RIGHT)),this.editors.left.ace.setReadOnly(!this.options.left.editable),this.editors.right.ace.setReadOnly(!this.options.right.editable),this.editors.left.ace.setTheme(c(this,G.EDITOR_LEFT)),this.editors.right.ace.setTheme(c(this,G.EDITOR_RIGHT)),this.options.merge.enabled?(this.editors.merge.ace.getSession().setMode(b(this,G.EDITOR_MERGE)),this.editors.merge.ace.setReadOnly(!this.options.merge.editable),this.editors.merge.ace.setTheme(c(this,G.EDITOR_MERGE)),v(this,this.options.classes.leftGutterID,"left"),t(this,this.options.classes.leftGutterID,"left"),v(this,this.options.classes.rightGutterID,"right"),t(this,this.options.classes.rightGutterID,"right")):(v(this,this.options.classes.gutterID),t(this,this.options.classes.gutterID)),this.options.left.content&&this.editors.left.ace.setValue(this.options.left.content,-1),this.options.right.content&&this.editors.right.ace.setValue(this.options.right.content,-1),this.options.merge.content&&this.editors.merge.ace.setValue(this.options.merge.content,-1),this.editors.editorHeight=B(this),this.diff()}function b(a,b){var c=a.options.mode;return b===G.EDITOR_LEFT&&null!==a.options.left.mode&&(c=a.options.left.mode),b===G.EDITOR_RIGHT&&null!==a.options.right.mode&&(c=a.options.right.mode),c}function c(a,b){var c=a.options.theme;return b===G.EDITOR_LEFT&&null!==a.options.left.theme&&(c=a.options.left.theme),b===G.EDITOR_RIGHT&&null!==a.options.right.theme&&(c=a.options.right.theme),c}function d(a){var b=(new Date).getTime();a.options.merge.enabled?(a.editors.merge.ace.getSession().on("changeScrollTop",function(c){var d=(new Date).getTime();d>b+50&&h(a,"merge",c)}),a.editors.right.ace.getSession().on("changeScrollTop",function(c){var d=(new Date).getTime();d>b+50&&h(a,"right",c)})):(a.editors.left.ace.getSession().on("changeScrollTop",function(c){var d=(new Date).getTime();d>b+50&&h(a,"left",c)}),a.editors.right.ace.getSession().on("changeScrollTop",function(c){var d=(new Date).getTime();d>b+50&&h(a,"right",c)}));var c=a.diff.bind(a);a.editors.left.ace.on("change",c),a.editors.right.ace.on("change",c),a.options.left.copyLinkEnabled&&(a.options.merge.enabled||D("#"+a.options.classes.gutterID,"click","."+a.options.classes.newCodeConnectorLink,function(b){e(a,b,G.LTR)})),a.options.right.copyLinkEnabled&&(a.options.merge.enabled?D("#"+a.options.classes.rightGutterID,"click","."+a.options.classes.deletedCodeConnectorLink,function(b){e(a,b,G.RTM)}):D("#"+a.options.classes.gutterID,"click","."+a.options.classes.deletedCodeConnectorLink,function(b){e(a,b,G.RTL)}));var d=E(function(){a.editors.availableHeight=document.getElementById(a.options.left.id).offsetHeight,a.diff()},250);window.addEventListener("resize",d)}function e(a,b,c){var d,e,f=parseInt(b.target.getAttribute("data-diff-index"),10),g=a.diffs[f];c===G.LTR?(d=a.editors.left,e=a.editors.right):c===G.RTM?(d=a.editors.right,e=a.editors.merge):(d=a.editors.right,e=a.editors.left);for(var h=g.rightStartLine,i=g.rightEndLine,j=g.leftStartLine,k=g.leftEndLine,l="",m=h;i>m;m++)l+=p(d,m)+"\n";for(var n="",m=0;j>m;m++)n+=p(e,m)+"\n";for(var o="",q=e.ace.getSession().getLength(),m=k;q>m;m++)o+=p(e,m),q-1>m&&(o+="\n");o=o.replace(/\s*$/,"");var r=e.ace.getSession().getScrollTop();e.ace.getSession().setValue(n+l+o),e.ace.getSession().setScrollTop(parseInt(r)),a.diff()}function f(a){var b=a.ace.getSession().doc.getAllLines(),c=[];return b.forEach(function(a){c.push(a.length+1)}),c}function g(a,b,c,d,e){var b=a.editors[b];c>d&&(d=c);var f=e+" "+(d>c?"lines":"targetOnly");d--,b.markers.push(b.ace.session.addMarker(new F(c,0,d,1),f,"fullLine"))}function h(a){i(a),z(a),l(a)}function i(a){a.options.merge.enabled?a.editors.merge.markers.forEach(function(a){this.editors.merge.ace.getSession().removeMarker(a)},a):a.editors.left.markers.forEach(function(a){this.editors.left.ace.getSession().removeMarker(a)},a),a.editors.right.markers.forEach(function(a){this.editors.right.ace.getSession().removeMarker(a)},a)}function j(a,b,c,d,e){var f=a.editors.left.ace.getSession().getScrollTop(),g=a.editors.right.ace.getSession().getScrollTop();a.options.merge.enabled&&(f=a.editors.merge.ace.getSession().getScrollTop()),a.connectorYOffset=1;var h=-1,i=b*a.lineHeight-f+.5,j=a.gutterWidth+1,k=d*a.lineHeight-g+.5,l=-1,m=c*a.lineHeight-f+a.connectorYOffset+.5,n=a.gutterWidth+1,o=e*a.lineHeight-g+a.connectorYOffset+.5,p=C(h,i,j,k),q=C(n,o,l,m),r="L"+j+","+k+" "+n+","+o,s="L"+l+","+m+" "+h+","+i,t=p+" "+r+" "+q+" "+s,u=document.createElementNS(G.SVG_NS,"path");u.setAttribute("d",t),u.setAttribute("class",a.options.classes.connector),a.options.merge.enabled?a.rightGutterSVG.appendChild(u):a.gutterSVG.appendChild(u)}function k(a,b,c){if(!a.options.merge.enabled&&b.leftEndLine>b.leftStartLine&&a.options.left.copyLinkEnabled){var d=s({className:a.options.classes.newCodeConnectorLink,topOffset:b.leftStartLine*a.lineHeight,tooltip:"Copy to right",diffIndex:c,arrowContent:a.options.classes.newCodeConnectorLinkContent});a.copyRightContainer.appendChild(d)}if(b.rightEndLine>b.rightStartLine&&a.options.right.copyLinkEnabled){var e=s({className:a.options.classes.deletedCodeConnectorLink,topOffset:(b.rightEndLine-1)*a.lineHeight,tooltip:"Copy to left",diffIndex:c,arrowContent:a.options.classes.deletedCodeConnectorLinkContent});a.options.merge.enabled?a.copyRightContainer.appendChild(e):a.copyLeftContainer.appendChild(e)}}function l(a){var b=a.editors.left.ace.getSession().getScrollTop(),c=a.editors.right.ace.getSession().getScrollTop();a.copyRightContainer.style.cssText="top: "+-b+"px",a.copyLeftContainer.style.cssText="top: "+-c+"px"}function m(a,b,c,d,e){var f={},g=/^\n/.test(e),h=a.options.merge.enabled?a.editors.merge:a.editors.left;if(b===G.DIFF_INSERT){var i=n(h,c,e),j=q(a.editors.right,d),k=o(a.editors.right,j),l=o(h,i.startLine),m=o(h,i.startLine),p=j;0===m&&g&&(g=!1),0===i.startChar&&r(a.editors.right,d,g)&&(p=j+1);var s=i.startLine===i.endLine,t=0;(i.startChar>0||s&&e.length<l)&&k>0&&i.startChar<l&&t++,f={leftStartLine:i.startLine,leftEndLine:i.endLine+1,rightStartLine:p,rightEndLine:p+t}}else{var i=n(a.editors.right,d,e),j=q(h,c),k=o(h,j),u=o(a.editors.right,i.startLine),m=o(a.editors.right,i.startLine),v=j;0===m&&g&&(g=!1),0===i.startChar&&r(h,c,g)&&(v=j+1);var s=i.startLine===i.endLine,t=0;(i.startChar>0||s&&e.length<u)&&k>0&&i.startChar<u&&t++,f={leftStartLine:v,leftEndLine:v+t,rightStartLine:i.startLine,rightEndLine:i.endLine+1}}return f}function n(a,b,c){var d={startLine:0,startChar:0,endLine:0,endChar:0},e=b+c.length,f=0,g=!1,h=!1;a.lineLengths.forEach(function(a,c){f+=a,!g&&f>b&&(d.startLine=c,d.startChar=b-f+a,g=!0),!h&&f>=e&&(d.endLine=c,d.endChar=e-f+a,h=!0)}),d.startChar>0&&o(a,d.startLine)===d.startChar&&(d.startLine++,d.startChar=0),0===d.endChar&&d.endLine--;var i=/\n$/.test(c);return d.startChar>0&&i&&d.endLine++,d}function o(a,b){return p(a,b).length}function p(a,b){return a.ace.getSession().doc.getLine(b)}function q(a,b){for(var c=a.ace.getSession().doc.getAllLines(),d=0,e=0,f=0;f<c.length;f++)if(e+=c[f].length+1,e>=b){d=f;break}return d}function r(a,b,c){for(var d=a.ace.getSession().doc.getAllLines(),e=0,f=!1,g=0;g<d.length;g++){e+=d[g].length+1;var h=e;if(c&&h--,b===h){f=!0;break}}return f}function s(a){var b=document.createElement("div"),c={"class":a.className,style:"top:"+a.topOffset+"px",title:a.tooltip,"data-diff-index":a.diffIndex};for(var d in c)b.setAttribute(d,c[d]);return b.innerHTML=a.arrowContent,b}function t(a,b,c){a.gutterHeight=document.getElementById(b).clientHeight,a.gutterWidth=document.getElementById(b).clientWidth;var d=u(a,G.EDITOR_LEFT),e=u(a,G.EDITOR_RIGHT),f=Math.max(d,e,a.gutterHeight);if(a.options.merge.enabled){var g=document.createElementNS(G.SVG_NS,"svg");g.setAttribute("width",a.gutterWidth),g.setAttribute("height",f),a[c+"GutterSVG"]=g,document.getElementById(b).appendChild(g)}else a.gutterSVG=document.createElementNS(G.SVG_NS,"svg"),a.gutterSVG.setAttribute("width",a.gutterWidth),a.gutterSVG.setAttribute("height",f),document.getElementById(b).appendChild(a.gutterSVG)}function u(a,b){var c=b===G.EDITOR_LEFT?a.editors.left:a.editors.right;return c.ace.getSession().getLength()*a.lineHeight}function v(a,b){a.copyRightContainer=document.createElement("div"),a.copyRightContainer.setAttribute("class",a.options.classes.copyRightContainer),document.getElementById(b).appendChild(a.copyRightContainer),a.copyLeftContainer=document.createElement("div"),a.copyLeftContainer.setAttribute("class",a.options.classes.copyLeftContainer),document.getElementById(b).appendChild(a.copyLeftContainer)}function w(a,b,c){var d=document.getElementById(b);d.removeChild(c?a[c+"GutterSVG"]:a.gutterSVG),t(a,b,c)}function x(a){a.copyLeftContainer.innerHTML="",a.copyRightContainer.innerHTML=""}function y(a,b){function c(b){return a.options.diffGranularity===G.DIFF_GRANULARITY_SPECIFIC?1>b:1>=b}var d=[];b.forEach(function(a,b){if(0===b)return void d.push(a);for(var e=!1,f=0;f<d.length;f++)if(c(Math.abs(a.leftStartLine-d[f].leftEndLine))&&c(Math.abs(a.rightStartLine-d[f].rightEndLine))){d[f].leftStartLine=Math.min(a.leftStartLine,d[f].leftStartLine),d[f].rightStartLine=Math.min(a.rightStartLine,d[f].rightStartLine),d[f].leftEndLine=Math.max(a.leftEndLine,d[f].leftEndLine),d[f].rightEndLine=Math.max(a.rightEndLine,d[f].rightEndLine),e=!0;break}e||d.push(a)});var e=[];return d.forEach(function(a){(a.leftStartLine!==a.leftEndLine||a.rightStartLine!==a.rightEndLine)&&e.push(a)}),e}function z(a){a.options.merge.enabled?(w(a,a.options.classes.leftGutterID,"left"),x(a,a.options.classes.leftGutterID),w(a,a.options.classes.rightGutterID,"right"),x(a,a.options.classes.rightGutterID)):(w(a,a.options.classes.gutterID),x(a,a.options.classes.gutterID)),a.diffs.forEach(function(a,b){this.options.showDiffs&&(this.options.merge.enabled?g(this,G.EDITOR_MERGE,a.leftStartLine,a.rightEndLine,this.options.classes.diff):g(this,G.EDITOR_LEFT,a.leftStartLine,a.leftEndLine,this.options.classes.diff),g(this,G.EDITOR_RIGHT,a.rightStartLine,a.rightEndLine,this.options.classes.diff),this.options.showConnectors&&j(this,a.leftStartLine,a.leftEndLine,a.rightStartLine,a.rightEndLine),k(this,a,b))},a)}function A(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1,k=Object.prototype.toString,l=Object.prototype.hasOwnProperty,m={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n={isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!==a&&a===a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return null===a?String(a):m[k.call(a)]||"object"},isPlainObject:function(a){if(!a||"object"!==n.type(a)||a.nodeType)return!1;try{if(a.constructor&&!l.call(a,"constructor")&&!l.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}var c;for(c in a);return void 0===c||l.call(a,c)}};for("boolean"==typeof g&&(j=g,g=arguments[1]||{},h=2),"object"==typeof g||n.isFunction(g)||(g={}),i===h&&(g=this,--h),h;i>h;h++)if(null!==(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=A(j,f,d)):void 0!==d&&(g[b]=d));return g}function B(a){return document.getElementById(a.options.left.id).offsetHeight}function C(a,b,c,d){var e=c-a,f=a+e/2,g="M "+a+" "+b+" C "+f+","+b+" "+f+","+d+" "+c+","+d;return g}function D(a,b,c,d){var e="document"===a?document:document.querySelector(a);e.addEventListener(b,function(a){for(var b=e.querySelectorAll(c),f=a.target,g=0,h=b.length;h>g;g++)for(var i=f,j=b[g];i&&i!==e;){if(i===j)return d.call(j,a);i=i.parentNode}})}function E(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}}var F=require("ace/range").Range,G={DIFF_EQUAL:0,DIFF_DELETE:-1,DIFF_INSERT:1,EDITOR_RIGHT:"right",EDITOR_LEFT:"left",EDITOR_MERGE:"merge",RTL:"rtl",LTR:"ltr",RTM:"rtm",SVG_NS:"http://www.w3.org/2000/svg",DIFF_GRANULARITY_SPECIFIC:"specific",DIFF_GRANULARITY_BROAD:"broad"};return a.prototype={setOptions:function(a){A(!0,this.options,a),this.diff()},getNumDiffs:function(){return this.diffs.length},getEditors:function(){return{left:this.editors.left.ace,right:this.editors.right.ace}},diff:function(){var a=new diff_match_patch,b=this.editors.left.ace.getSession().getValue(),c=this.editors.right.ace.getSession().getValue();this.options.merge.enabled&&(b=this.editors.merge.ace.getSession().getValue(),this.editors.merge.lineLengths=f(this.editors.merge)),this.editors.left.lineLengths=f(this.editors.left),this.editors.right.lineLengths=f(this.editors.right);var d=a.diff_main(c,b);a.diff_cleanupSemantic(d);var e=[],g={left:0,right:0};d.forEach(function(a){var b=a[0],c=a[1];0!==c.length&&(b===G.DIFF_EQUAL?(g.left+=c.length,g.right+=c.length):b===G.DIFF_DELETE?(e.push(m(this,G.DIFF_DELETE,g.left,g.right,c)),g.right+=c.length):b===G.DIFF_INSERT&&(e.push(m(this,G.DIFF_INSERT,g.left,g.right,c)),g.left+=c.length))},this),this.diffs=y(this,e),this.diffs.length>this.options.maxDiffs||(i(this),z(this))},destroy:function(){var a=this.editors.left.ace.getValue();this.editors.left.ace.destroy();var b=this.editors.left.ace.container,c=b.cloneNode(!1);c.textContent=a,b.parentNode.replaceChild(c,b);var d=this.editors.right.ace.getValue();if(this.editors.right.ace.destroy(),b=this.editors.right.ace.container,c=b.cloneNode(!1),c.textContent=d,b.parentNode.replaceChild(c,b),this.options.merge.enabled){document.getElementById(this.options.classes.leftGutterID).innerHTML="",document.getElementById(this.options.classes.rightGutterID).innerHTML="";var e=this.editors.merge.ace.getValue();this.editors.merge.ace.destroy(),b=this.editors.merge.ace.container,c=b.cloneNode(!1),c.textContent=e,b.parentNode.replaceChild(c,b)}else document.getElementById(this.options.classes.gutterID).innerHTML=""}},a});