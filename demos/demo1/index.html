<!doctype html>
<html lang="en">
  <head>
    <title>Ace-diff - Demo #1</title>
    <!-- Include Ace editor first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.js"></script>
    <!-- Include Ace-diff CSS -->
    <link
      href="https://unpkg.com/ace-diff@3/dist/ace-diff.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- Element we will use to render the Ace-diff -->
    <div class="custom"></div>

    <script type="module">
      import AceDiff from "https://esm.sh/ace-diff@3";
      var aceDiffer = new AceDiff({
        element: ".custom",
        left: {
          content: `function copy(acediff, e, dir) {
  const diffIndex = parseInt(e.target.getAttribute('data-diff-index'), 10)
  const diff = acediff.diffs[diffIndex]

  let sourceEditor
  let targetEditor

  let startLine
  let endLine
  let targetStartLine
  let targetEndLine
  if (dir === C.LTR) {
    sourceEditor = acediff.editors.left
    targetEditor = acediff.editors.right
    startLine = diff.leftStartLine
    endLine = diff.leftEndLine
    targetStartLine = diff.rightStartLine
    targetEndLine = diff.rightEndLine
  } else {
    sourceEditor = acediff.editors.right
    targetEditor = acediff.editors.left
    startLine = diff.rightStartLine
    endLine = diff.rightEndLine
    targetStartLine = diff.leftStartLine
    targetEndLine = diff.leftEndLine
  }

  let contentToInsert = ''
  for (let i = startLine; i < endLine; i += 1) {
    contentToInsert += getLine(sourceEditor, i)
    // JMT: If the first line is blank we add an extra newline
    // because when it is inserted the first one is effectively eaten
    // by the replace and merging of the lines
    // However if the targetStartLine is the very top then we don't
    // if (i === startLine && contentToInsert === '' && targetStartLine != 0) {
    //   contentToInsert += '\n'
    // }
    // Only add a trailing newline if we're not on the final line
    if (i < sourceEditor.ace.getSession().getLength() - 1) {
      contentToInsert += '\n'
    }
  }

  // keep track of the scroll height
  const h = targetEditor.ace.getSession().getScrollTop()

  targetEditor.ace
    .getSession()
    .replace(new Range(targetStartLine, 0, targetEndLine, 0), contentToInsert)
  targetEditor.ace.getSession().setScrollTop(parseInt(h, 10))

  acediff.diff()
}`,
        },
        right: {
          content: `function copy(acediff, e, dir) {
  const diffIndex = parseInt(e.target.getAttribute('data-diff-index'), 10)
  const diff = acediff.diffs[diffIndex]

  let sourceEditor
  let targetEditor
  let sourceStartOffset
  let sourceEndOffset
  let targetStartOffset
  let targetEndOffset

  if (dir === C.LTR) {
    sourceEditor = acediff.editors.left
    targetEditor = acediff.editors.right
    sourceStartOffset = diff.leftStartOffset
    sourceEndOffset = diff.leftEndOffset
    targetStartOffset = diff.rightStartOffset
    targetEndOffset = diff.rightEndOffset
  } else {
    sourceEditor = acediff.editors.right
    targetEditor = acediff.editors.left
    sourceStartOffset = diff.rightStartOffset
    sourceEndOffset = diff.rightEndOffset
    targetStartOffset = diff.leftStartOffset
    targetEndOffset = diff.leftEndOffset
  }

  // Get the content to insert using character offsets from the source
  const sourceValue = sourceEditor.ace.getValue()
  const contentToInsert = sourceValue.substring(sourceStartOffset, sourceEndOffset)

  // Use Ace's built-in indexToPosition for precise character-to-position conversion
  const targetDoc = targetEditor.ace.getSession().doc
  const startPos = targetDoc.indexToPosition(targetStartOffset)
  const endPos = targetDoc.indexToPosition(targetEndOffset)

  // keep track of the scroll height
  const h = targetEditor.ace.getSession().getScrollTop()

  // Use character-precise range for the replacement
  targetEditor.ace
    .getSession()
    .replace(new Range(startPos.row, startPos.column, endPos.row, endPos.column), contentToInsert)
  targetEditor.ace.getSession().setScrollTop(parseInt(h, 10))

  acediff.diff()
}`,
        },
      });
    </script>
  </body>
</html>
