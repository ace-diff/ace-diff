<!doctype html>
<html lang="en">
  <head>
    <title>Ace-diff - Demo #2</title>
    <!-- Include Ace editor first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.js"></script>
    <!-- Include Ace-diff CSS -->
    <link
      href="https://unpkg.com/ace-diff@3/dist/ace-diff.min.css"
      rel="stylesheet"
    />

    <!-- Bootstrap for additional styling of the demo -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.min.css"
    />
  </head>

  <body>
    <!-- Element we will use to render the Ace-diff -->
    <div class="container">
      <h1>Placing Ace-diff only in part of the page</h1>
      <div class="row">
        <div class="col-sm-4">
          <p>
            Ace-diff doesn't have to take 100% of the page, it can easily be
            placed into some wrapping element and positioned wherever you need
            it to be.
          </p>
          <hr />
          <h2>Troubleshooting</h2>
          <p>
            If you run into an issue where you can't see the Ace-diff, try
            giving the wrapping element some width and height.
          </p>
          <hr />
          <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam
            scelerisque congue dui, id dapibus erat commodo sit amet. Orci
            varius natoque penatibus et magnis dis parturient montes, nascetur
            ridiculus mus. In non sapien eget tellus condimentum rhoncus quis
            eget odio. Proin sodales nisi at arcu pretium, semper dapibus nisi
            viverra. Nam orci lacus, interdum a convallis et, condimentum quis
            sem. Sed faucibus volutpat dolor eu lacinia. Pellentesque libero
            justo, rhoncus a ipsum at, pretium ultricies felis. In maximus sit
            amet orci in posuere.
          </p>
        </div>
        <div class="col-sm-8">
          <div class="custom"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import AceDiff from "https://esm.sh/ace-diff@3";
      var aceDiffer = new AceDiff({
        element: ".custom",
        left: {
          content: `function copy(acediff, e, dir) {
  const diffIndex = parseInt(e.target.getAttribute('data-diff-index'), 10)
  const diff = acediff.diffs[diffIndex]

  let sourceEditor
  let targetEditor

  let startLine
  let endLine
  let targetStartLine
  let targetEndLine
  if (dir === C.LTR) {
    sourceEditor = acediff.editors.left
    targetEditor = acediff.editors.right
    startLine = diff.leftStartLine
    endLine = diff.leftEndLine
    targetStartLine = diff.rightStartLine
    targetEndLine = diff.rightEndLine
  } else {
    sourceEditor = acediff.editors.right
    targetEditor = acediff.editors.left
    startLine = diff.rightStartLine
    endLine = diff.rightEndLine
    targetStartLine = diff.leftStartLine
    targetEndLine = diff.leftEndLine
  }

  let contentToInsert = ''
  for (let i = startLine; i < endLine; i += 1) {
    contentToInsert += getLine(sourceEditor, i)
    // JMT: If the first line is blank we add an extra newline
    // because when it is inserted the first one is effectively eaten
    // by the replace and merging of the lines
    // However if the targetStartLine is the very top then we don't
    // if (i === startLine && contentToInsert === '' && targetStartLine != 0) {
    //   contentToInsert += '\n'
    // }
    // Only add a trailing newline if we're not on the final line
    if (i < sourceEditor.ace.getSession().getLength() - 1) {
      contentToInsert += '\n'
    }
  }

  // keep track of the scroll height
  const h = targetEditor.ace.getSession().getScrollTop()

  targetEditor.ace
    .getSession()
    .replace(new Range(targetStartLine, 0, targetEndLine, 0), contentToInsert)
  targetEditor.ace.getSession().setScrollTop(parseInt(h, 10))

  acediff.diff()
}`,
        },
        right: {
          content: `function copy(acediff, e, dir) {
  const diffIndex = parseInt(e.target.getAttribute('data-diff-index'), 10)
  const diff = acediff.diffs[diffIndex]

  let sourceEditor
  let targetEditor
  let sourceStartOffset
  let sourceEndOffset
  let targetStartOffset
  let targetEndOffset

  if (dir === C.LTR) {
    sourceEditor = acediff.editors.left
    targetEditor = acediff.editors.right
    sourceStartOffset = diff.leftStartOffset
    sourceEndOffset = diff.leftEndOffset
    targetStartOffset = diff.rightStartOffset
    targetEndOffset = diff.rightEndOffset
  } else {
    sourceEditor = acediff.editors.right
    targetEditor = acediff.editors.left
    sourceStartOffset = diff.rightStartOffset
    sourceEndOffset = diff.rightEndOffset
    targetStartOffset = diff.leftStartOffset
    targetEndOffset = diff.leftEndOffset
  }

  // Get the content to insert using character offsets from the source
  const sourceValue = sourceEditor.ace.getValue()
  const contentToInsert = sourceValue.substring(sourceStartOffset, sourceEndOffset)

  // Use Ace's built-in indexToPosition for precise character-to-position conversion
  const targetDoc = targetEditor.ace.getSession().doc
  const startPos = targetDoc.indexToPosition(targetStartOffset)
  const endPos = targetDoc.indexToPosition(targetEndOffset)

  // keep track of the scroll height
  const h = targetEditor.ace.getSession().getScrollTop()

  // Use character-precise range for the replacement
  targetEditor.ace
    .getSession()
    .replace(new Range(startPos.row, startPos.column, endPos.row, endPos.column), contentToInsert)
  targetEditor.ace.getSession().setScrollTop(parseInt(h, 10))

  acediff.diff()
}`,
        },
      });
    </script>
  </body>
</html>
